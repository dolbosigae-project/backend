<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gae.mapper.MemberMapper">

  <!-- 회원 + 펫 정보 -->
  <resultMap type="com.gae.dto.BoardMemberDTO" id="member">
    <id column="MEMBER_ID" property="boardMemberId"/>
    <result column="MEMBER_PASSWORD" property="boardMemberPasswd"/>
    <result column="MEMBER_NAME" property="boardMemberName"/>
    <result column="MEMBER_REGION" property="boardMemberRegion"/>
    <result column="MEMBER_GRADE_NO" property="boardMemberGradeNo"/>
    <result column="MEMBER_GRADE_NAME" property="boardMemberGradeName"/>
    <result column="MEMBER_PETWITH" property="boardMemberPetWith" jdbcType="CHAR"/>
    <result column="PET_ID" property="petId"/>
    <result column="PET_NICKNAME" property="boardMemberNick"/>
    <result column="PET_BIRTH" property="petBirth"/>
    <result column="PET_GENDER" property="petGender" jdbcType="CHAR"/>
    <result column="PET_SIZE" property="petSize"/>
    <result column="PET_WEIGHT" property="petWeight"/>
    <result column="PET_WALKPROFILE" property="petWalkProfile" jdbcType="CHAR"/>
    <result column="PET_IMAGE_NO" property="petImageNo" jdbcType="CHAR"/>
    <result column="PET_IMAGE_PATH" property="petImagePath"/>
    <result column="PET_INFO" property="petInfo"/>
  </resultMap>

  <!-- 로그인 -->
  <select id="login" resultMap="member">
    <![CDATA[
      SELECT *
      FROM MEMBER_PET_VIEW
      WHERE MEMBER_ID = #{id}
      AND MEMBER_PASSWORD = STANDARD_HASH(#{pass}, 'SHA512')
    ]]>
  </select>
    
  <!-- 비밀번호 설정하기 -->
  <update id="updatePasswd" parameterType="member">
  <![CDATA[
  	UPDATE "MEMBER" SET  
	M_PW = STANDARD_HASH(#{boardMemberPasswd}, 'SHA512')
	WHERE M_ID LIKE #{boardMemberId}
    ]]>
  </update>

  <!-- 전체 멤버 수 조회 -->
  <select id="getTotalCount" resultType="int">
    <![CDATA[
      SELECT COUNT(*) FROM MEMBER_PET_VIEW
    ]]>
  </select>

  <!-- 멤버 리스트 조회 (페이징) -->
  <select id="getMemberList" resultMap="member">
    <![CDATA[
      SELECT *
      FROM (
        SELECT A.*, ROWNUM AS RNUM
        FROM (
          SELECT *
          FROM MEMBER_PET_VIEW
          ORDER BY MEMBER_ID
        ) A
        WHERE ROWNUM <= #{endRow}
      )
      WHERE RNUM > #{startRow}
    ]]>
  </select>
  
  <!-- 회원 정보 삭제 -->
  <delete id="deleteMember">
    <![CDATA[
      DELETE FROM MEMBER
      WHERE M_ID = #{id}
    ]]>
  </delete>
  
	<!-- 회원 테이블 업데이트 -->
	<update id="updateMember" parameterType="com.gae.dto.BoardMemberDTO">
	<![CDATA[
	  UPDATE "MEMBER" SET  
	    M_GRADE_NO = #{boardMemberGradeNo},
	    M_NAME = #{boardMemberName},
	    M_REGION = #{boardMemberRegion},
	    M_PETWITH = #{boardMemberPetWith}
	  WHERE M_ID = #{boardMemberId}
	]]>
	</update>
	
	<!-- 회원 테이블 업데이트(해시값 변경으로 비밀번호 분리함) -->
	<update id="updateMemberPassword" parameterType="com.gae.dto.BoardMemberDTO">
	<![CDATA[
	  UPDATE "MEMBER" SET  
	    M_PW = STANDARD_HASH(#{boardMemberPasswd}, 'SHA512')
	  WHERE M_ID = #{boardMemberId}
	]]>
	</update>
  
  <!-- 펫 테이블 업데이트 -->
  <update id="updatePet" parameterType="member">
  <![CDATA[
  	UPDATE PET SET 
	P_NICK = #{boardMemberNick},
	P_BIRTH = #{petBirth},
	P_GENDER = #{petGender},
	P_SIZE = #{petSize},
	P_WEIGHT = #{petWeight},
	P_INFO = #{petInfo},
	P_WALKPROFILE = #{petWalkProfile}
	WHERE M_ID LIKE #{boardMemberId}
    ]]>
  </update>
  
   <!-- 회원 검색 박스 -->
  <select id="searchByBoardMemberId" resultMap="member">
    <![CDATA[
      SELECT * FROM MEMBER_PET_VIEW WHERE MEMBER_ID LIKE '%' || #{term} || '%'
    ]]>
  </select>

  <select id="searchByBoardMemberName" resultMap="member">
    <![CDATA[
      SELECT * FROM MEMBER_PET_VIEW WHERE MEMBER_NAME LIKE '%' || #{term} || '%'
    ]]>
  </select>

  <select id="searchByBoardMemberRegion" resultMap="member">
    <![CDATA[
      SELECT * FROM MEMBER_PET_VIEW WHERE MEMBER_REGION LIKE '%' || #{term} || '%'
    ]]>
  </select>

  <select id="searchByBoardMemberGradeName" resultMap="member">
    <![CDATA[
      SELECT * FROM MEMBER_PET_VIEW WHERE MEMBER_GRADE_NAME LIKE '%' || #{term} || '%'
    ]]>
  </select>
  
  <!-- 마이페이지 -->
  <select id="myPage" resultMap="member">
    <![CDATA[
      SELECT * FROM MEMBER_PET_VIEW WHERE MEMBER_ID = #{id}
    ]]>
  </select>
  
  <!-- 아이디 중복 확인 -->
  <select id="checkDuplicate" parameterType="String" resultType="int">
  	SELECT COUNT(*) FROM MEMBER_PET_VIEW WHERE MEMBER_ID = #{idValue}
  </select>
  
  <!-- 회원가입 (회원정보) -->
  <insert id="insertMember" parameterType="com.gae.dto.BoardMemberDTO">
    INSERT INTO MEMBER (M_ID, M_NAME, M_PW, M_REGION, M_PETWITH)
    VALUES (#{boardMemberId}, #{boardMemberName}, STANDARD_HASH(#{boardMemberPasswd}, 'SHA512'), #{boardMemberRegion}, #{boardMemberPetWith})
  </insert>
   
    <!-- 회원가입 (펫정보) -->
  	<insert id="insertPet" parameterType="com.gae.dto.BoardMemberDTO">
    INSERT INTO PET (P_ID, M_ID, P_NICK, P_BIRTH, P_GENDER, P_SIZE, P_WEIGHT, P_INFO, P_WALKPROFILE)
    VALUES (PET_ID_SEQ.NEXTVAL, #{boardMemberId}, #{boardMemberNick}, #{petBirth}, #{petGender}, #{petSize}, #{petWeight}, #{petInfo}, #{petWalkProfile})
    <selectKey keyProperty="pId" resultType="String" order="AFTER">
        SELECT TO_CHAR(PET_ID_SEQ.CURRVAL) FROM DUAL
    </selectKey>
	</insert>

  <insert id="insertDefaultPet" parameterType="com.gae.dto.BoardMemberDTO">
    INSERT INTO PET (P_ID, M_ID, P_NICK, P_BIRTH, P_GENDER, P_SIZE, P_WEIGHT, P_INFO)
    VALUES (PET_ID_SEQ.NEXTVAL, #{boardMemberId}, #{boardMemberNick}, '0000-00', 'M', '소형견', '0.0', 'No pet information')
  </insert>
  
  	<insert id="insertPetImg" parameterType="com.gae.dto.BoardMemberDTO">
    INSERT INTO P_IMG (P_ID, P_IMG_NO, P_IMG_PATH)
    VALUES (
        #{pId}, 
        CASE 
            WHEN #{petImagePath} IS NULL THEN 0 
            ELSE P_IMG_NO_SEQ.NEXTVAL 
        END, 
        #{petImagePath}
    )
	</insert>
  
  
  

</mapper>


